<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><title>Hacking Roombas | AOE OpenSource</title><meta name=description content="Make Roombas move around and see things | We present our AOE open source projects"><meta name=keywords content="aoe,aoe wiesbaden,aoe it,open source,digital projects,Roomba,Tasmota,ESP32,OpenCV,ArUco"><meta name=robots content="index, follow"><link rel=canonical href=https://opensource.aoe.com/posts/hacking-roombas/><link rel=apple-touch-icon sizes=180x180 href=https://opensource.aoe.com/dist/images/apple-touch-icon.8c60b602525ce5dfbb8e829a047f0a8170707f7253dcf358922e6738c15847c1.png><link rel=icon type=image/png sizes=32x32 href=https://opensource.aoe.com/dist/images/favicon-32x32.d141108f34b924f777a847a9a34ffc75fdd1b153249de705eed4d61cd1084e34.png><link rel=icon type=image/png sizes=16x16 href=https://opensource.aoe.com/dist/images/favicon-16x16.4b437bbabb4a6de6070b0dead9ad87cebd5719dc782739808897c2440b1ea5b3.png><link rel=preload href=https://opensource.aoe.com/dist/css/brands.min.min.ff427499cf03b219c0264a0108d196336628bc856273bd4c79d338adeffde06c.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link href=https://opensource.aoe.com/dist/css/brands.min.min.ff427499cf03b219c0264a0108d196336628bc856273bd4c79d338adeffde06c.css rel=stylesheet as=style></noscript><link rel=preload href=https://opensource.aoe.com/dist/css/roboto-fonts.min.3eee503acbe2b79931c006fbe01addd4407e15676be55769dfb5d4274d6d7a3e.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link href=https://opensource.aoe.com/dist/css/roboto-fonts.min.3eee503acbe2b79931c006fbe01addd4407e15676be55769dfb5d4274d6d7a3e.css rel=stylesheet as=style></noscript><link rel=stylesheet href=https://opensource.aoe.com/dist/css/main.min.39ab7f1dcbdba0d65d7b18f3b6481a7852f8e343a25560cbc38c26eb7d32fdad.css></head><body class="text-aoe-gray-dark bg-white text-lg"><div class="shadow-header inset-x-0 h-24"><div class="container mx-auto py-8 px-1 sm:px-8"><a href=/><img src=https://opensource.aoe.com/dist/images/aoe_blue.c3066d1f92ce78fa934f55765595eaa3e69ca702ddd087471b9a096e444eecd7.svg class="h-12 float-left pr-4" width=136 height=48 alt=AOE><div class=text-3xl>❤️ Open Source</div></a></div></div><div class=min-h-screen><div class=bg-gradient-gray-light><div class="container text-center"><h2>Hacking Roombas</h2><div class="meta font-medium text-aoe-gray-medium">2022-05-30, by</div><div class="meta font-bold aoe-gray-dark">Fabrizio Branca</div></div></div><div class=bg-gradient-gray-light><div class=container><div class="mx-auto prose lg:prose-xl md:prose-lg text-aoe-gray-dark text-lg"><p>When <a href=https://twitter.com/fbrnc/status/806231216861147137>I opened the box</a> of my Roomba back in 2016 there was a sticker saying:</p><blockquote><p>This robot contains an electronic and software interface that allows you to control or modify, and remotely monitor its sensors. For software programmers interested in giving your iRobot new functionality we encourage you to do so.</p></blockquote><p><a href=https://twitter.com/fbrnc/status/889569236401741824>A little later I first started playing</a> with microcontrollers sending infrared commands to the IR sensor in order to start cleaning via my home network (or specifically by pressing one of the Amazon Dash buttons that came out at that time).</p><p>While newer generations of the Roomba product line already come with wifi and cameras I always wanted to be able to add that myself.</p><p>Although it may sound a little over-engineered here&rsquo;s my current project:</p><p>Under the top cover of the Roomba there&rsquo;s a serial interface connector hidden. Using a <a href=https://www.irobot.lv/uploaded_files/File/iRobot_Roomba_500_Open_Interface_Spec.pdf>documented serial interface</a> you can easily send either higher-level commands like start cleaning, stopping, and seeking the dock, or low-level commands like reading individual sensor values, controlling the motors or even playing notes on the internal speaker.</p><h2 id=esp32-firmware>ESP32 Firmware</h2><p>Using an <a href=https://www.espressif.com/en/products/socs/esp32>ESP32 microcontroller</a> I was able to &ldquo;bridge&rdquo; the serial interface to <a href=https://mqtt.org/>MQTT</a> and an HTTP api. Instead of implementing everything from scratch I used the <a href=https://tasmota.github.io/docs/>Tasmota firmware</a>. Tasmota is a great open-source firmware for ESP8266 and ESP32 microcontrollers that helped me doing getting started without any custom code on the microcontroller.</p><h2 id=hardware>Hardware</h2><p>I used an ESP32-cam board (later more on the &ldquo;cam&rdquo; part). This board is cheaply available. Make sure you also get the dev-board since the ESP32-cam board itself doesn&rsquo;t come with a USB connector and you&rsquo;d end up fiddling around with additional components. The ESP32 runs on 3.3V (and most boards have a built-in voltage regulator for 5V, which is the USB voltage). But the Roomba connector only includes an unregulated output that can range from 15 to 17V. So we need to drop that voltage safely. While some people suggest using a cheap USB car carger this didn&rsquo;t work for me so I ordered some MP1584EN buck converters.
Roomba&rsquo;s RX pin works fine the the ESP32 3.3V output, but the data returned from Roomba&rsquo;s TX been needed an extra PNP transistor (I used an 2N3906) so that the signal was readable reliably.
Since I also wanted to capture a video feed I replaced the OV2640 cam with a different fisheye lens with a longer cable. This is what my prototype board looks like:</p><p><picture><source srcset=/posts/hacking-roombas/images/proto_top_hu29e6109d9f08f9758011ee57c75d3f0e_166454_730x0_resize_q75_h2_box.webp><img src=/posts/hacking-roombas/images/proto_top_hu29e6109d9f08f9758011ee57c75d3f0e_166454_730x0_resize_q90_box.jpg alt="Prototype board (top view)"></picture>
<picture><source srcset=/posts/hacking-roombas/images/proto_bottom_hub3971683b4790db086d6aa5a8c862538_159102_730x0_resize_q75_h2_box.webp><img src=/posts/hacking-roombas/images/proto_bottom_hub3971683b4790db086d6aa5a8c862538_159102_730x0_resize_q90_box.jpg alt="Prototype board (bottom view)"></picture>
<picture><source srcset=/posts/hacking-roombas/images/roomba_and_esp32_hu7c35c0f70668fc904163906e403679c4_150242_730x0_resize_q75_h2_box.webp><img src=/posts/hacking-roombas/images/roomba_and_esp32_hu7c35c0f70668fc904163906e403679c4_150242_730x0_resize_q90_box.jpg alt="Prototype board (connected to Roomba))"></picture></p><h2 id=camera>Camera</h2><p>Getting the camera up and running with Tasmota required some extra steps. Carlos Gomes wrote <a href=https://cgomesu.com/blog/Esp32cam-tasmota-webcam-server/>an excellent article with step-by-step instructions</a>. With the new firmware in place you get the video-feed embedded into the Tasmota web interface.</p><h2 id=serial-communication>Serial communication</h2><p>Controlling the Roomba can be done easily via serial commands and those commands can be send via Tasmota out of the box. Here are some examples of the basic operations:</p><pre tabindex=0><code># Start:
Backlog SerialSend6 128; Delay 0.1; SerialSend6 131; Delay 0.1; SerialSend6 135;

# Seek Dock:
Backlog SerialSend6 128; Delay 0.1; SerialSend6 131; Delay 0.1; SerialSend6 143;

# Stop
Backlog SerialSend6 128; Delay 0.1; SerialSend6 131; Delay 0.1; SerialSend6 141;

# Drive in reverse at a velocity of -200 mm/s while turning at a radius of 500mm (byte sequence: [137] [255] [56] [1] [244]=
Backlog SerialSend6 128; Delay 0.1; SerialSend6 131; Delay 0.1; SerialSend6 137; Delay 0.1; SerialSend6 255; Delay 0.1; SerialSend6 56; Delay 0.1; SerialSend6 1; Delay 0.1; SerialSend6 244;
</code></pre><h2 id=berryscript>Berryscript</h2><p>The Tasmota firmware running on ESP32s allows you to write simple scripts using the <a href=https://diazvictor.github.io/berry_web/>Berry scripting language</a>. Based on Leon Wright&rsquo;s <a href=https://github.com/arendst/Tasmota/discussions/14136>post</a> and <a href=https://gist.github.com/techman83/45ed4f6de5ff4df0a2de036e33aab0f1>code</a> I built a &ldquo;Roomba driver&rdquo; for Tasmota that allows controlling the roomba with a little on-screen joystick:</p><picture><source srcset=/posts/hacking-roombas/images/tasmota_hu5d4d4af13a53f9dee6df2227e73445ae_101257_730x0_resize_q75_h2_box.webp><img src=/posts/hacking-roombas/images/tasmota_hu5d4d4af13a53f9dee6df2227e73445ae_101257_730x0_resize_q90_box.jpg alt="Tasmota Web Interface with Roomba controls"></picture><p>Additionally I also added new commands to the Tasmota API that can easily be accessed via MQTT or HTTP:</p><ul><li>RoombaRestart</li><li>RoombaClean</li><li>RoombaDock</li><li>RoombaStop</li><li>RoombaDriveLeft</li><li>RoombaDriveRight</li><li>RoombaDriveForward</li><li>RoombaDriveBackward</li><li>RoombaDriveStop</li><li>RoombaWake</li><li>RoombaSleep</li><li>RoombaSerialRaw</li></ul><h2 id=opencv>OpenCV</h2><p>From here I was able to control the Roomba via the Tasmota web interface and programmatically via MQTT and HTTP. But my goal was to allow the Roomba to become a little smarter. Since the ESP32 microcontroller isn&rsquo;t very powerful I wrote some scripts that look at the video stream and control the Roomba via the API. The delay of the camera stream and the slow responsiveness of the API make things harder, but it works. A more powerful single board computer (maybe an Nvidia Jetson Nano&mldr;) would probably have been a better choice.</p><p>Using <a href=https://opencv.org/>OpenCV</a> I had the Roomba look for <a href=https://docs.opencv.org/4.x/d5/dae/tutorial_aruco_detection.html>ArUco markers</a>. ArUco markers allow OpenCV to estimate the pose of the marker. Using some filtering the jittering can be smoothed out a little bit. Now the goal was to have the Roomba position itself right in front of an ArUco marker at a right angle and at a given distance.</p><img src=images/roomba_nav.gif alt="Seeing ArUco markers"><h2 id=applications>Applications</h2><p>With this in place many applications are possible. With multiple ArUco markers sticking on the walls it could be possible to create a map of the room or to make Roomba navigate to given waypoints.
Sticking an ArUco marker on the top of the Roomba and observing it with an external camera might be another fun experiment.</p></div></div></div></div><div class=bg-aoe-gray><div class=container><div class="flex flex-row mx-auto prose lg:prose-xl md:prose-lg"><img src=https://opensource.aoe.com/dist/images/aoe_blue.c3066d1f92ce78fa934f55765595eaa3e69ca702ddd087471b9a096e444eecd7.svg class="basis-1/6 h-10" width=122 height=40 alt=AOE><div class="basis-5/6 text-aoe-gray-dark text-sm pl-4">AOE is a leading global provider of services for digital transformation and digital business models. AOE relies
exclusively on established Enterprise Open Source technologies. This leads to innovative solutions, digital
products
and portals in agile software projects, and helps build long-lasting, strategic partnerships with our customers.</div></div><div class="pt-8 text-3xl text-aoe-dark-blue text-center"><a href=https://www.facebook.com/aoepeople target=_blank class="mx-2 md:mx-8" aria-label=Facebook rel=noreferrer><span class="fab fa-facebook-f"></span></a>
<a href=https://twitter.com/aoepeople target=_blank class="mx-2 md:mx-8" aria-label=Twitter rel=noreferrer><span class="fab fa-twitter"></span></a>
<a href=https://www.linkedin.com/company/aoe target=_blank class="mx-2 md:mx-8" aria-label=Linkedin rel=noreferrer><span class="fab fa-linkedin-in"></span></a>
<a href=https://www.xing.com/company/aoe target=_blank class="mx-2 md:mx-8" aria-label=Xing rel=noreferrer><span class="fab fa-xing"></span></a>
<a href=https://www.instagram.com/aoepeople target=_blank class="mx-2 md:mx-8" aria-label=Instagram rel=noreferrer><span class="fab fa-instagram"></span></a>
<a href=https://www.youtube.com/user/aoepeople target=_blank class="mx-2 md:mx-8" aria-label=Youtube rel=noreferrer><span class="fab fa-youtube"></span></a>
<a href=https://github.com/AOEpeople/ target=_blank class="mx-2 md:mx-8" aria-label=Github rel=noreferrer><span class="fab fa-github"></span></a></div><div class="pt-8 text-center text-sm"><a href=https://www.aoe.com/en/imprint.html class=text-aoe-dark-blue>Legal Information</a></div></div></div><script>var _paq=window._paq=window._paq||[];_paq.push(["disableCookies"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="https://www.aoe.com/matomo/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","4"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script><noscript><p><img src="https://www.aoe.com/matomo/matomo.php?idsite=4&;rec=1" style=border:0 alt></p></noscript></body></html>